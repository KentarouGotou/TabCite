<!doctype html>
<html lang="ja">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>TabCite — VexFlow タブ譜エディタ(試作)</title>
		<style>
			:root {
				--bg: #0f1220;
				--panel: #161a2f;
				--text: #e8eaf6;
				--muted: #aab0d0;
				--accent: #7aa2f7;
				--danger: #ef5350;
			}
			html, body { height: 100%; }
			body {
				margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
				color: var(--text); background: radial-gradient(1200px 600px at 0% 0%, #141835, #0f1220 60%);
			}
			header {
				padding: 18px 20px; border-bottom: 1px solid #252a47; background: linear-gradient(180deg, #151934 0, #13162b 100%);
				position: sticky; top: 0; z-index: 10;
			}
			header h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
			main { max-width: 1000px; margin: 20px auto; padding: 0 16px 120px; }
			.panel { background: var(--panel); border: 1px solid #282d4f; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
			.toolbar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; padding: 14px; border-bottom: 1px solid #282d4f; }
			.toolbar label { font-size: 12px; color: var(--muted); }
			.toolbar input[type="text"], .toolbar select {
				background: #0f1326; color: var(--text); border: 1px solid #2a2f50; border-radius: 8px; padding: 10px 12px; font-size: 14px;
			}
			.toolbar .field { display: grid; gap: 6px; }
			.toolbar .field.small { width: 120px; }
			.toolbar .field.medium { min-width: 240px; flex: 1; }
			button {
				cursor: pointer; border: 1px solid #2a2f50; color: var(--text); background: #111533; padding: 10px 14px; border-radius: 8px; font-size: 14px;
				transition: .15s ease-in-out; display: inline-flex; align-items: center; gap: 8px;
			}
			button:hover { border-color: #3a3f65; background: #151a3e; }
			.btn-accent { border-color: #2c3b73; background: #16214a; }
			.btn-accent:hover { border-color: #3b4e96; background: #1b2756; }
			.btn-danger { border-color: #5e2b2b; background: #2a1313; }
			.btn-danger:hover { border-color: #8a3a3a; background: #311717; }
			#stage { padding: 20px; display: grid; place-items: center; }
			#renderer { width: 100%; overflow: auto; }
			.help { color: var(--muted); font-size: 12px; padding: 10px 14px; border-top: 1px dashed #2a3054; }
			.status { font-size: 12px; color: var(--muted); padding: 6px 0 0 2px; min-height: 18px; }
			.row { display: flex; gap: 12px; align-items: end; }
			.spacer { flex: 1; }
			a { color: var(--accent); text-decoration: none; }
			a:hover { text-decoration: underline; }
			.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
		</style>
	</head>
	<body>
		<header>
			<h1>TabCite — VexFlow タブ譜エディタ(試作)</h1>
		</header>
		<main>
			<div class="panel">
				<div class="toolbar">
					<div class="row" style="flex-wrap: wrap; width: 100%">
						<div class="field small">
							<label for="duration">音価</label>
							<select id="duration" aria-label="音価">
								<option value="w">全</option>
								<option value="h">2分</option>
								<option value="q" selected>4分</option>
								<option value="8">8分</option>
								<option value="16">16分</option>
							</select>
						</div>

						<div class="field medium" style="min-width: 320px;">
							<label for="positions">ポジション (例: <span class="mono">6:3 5:5</span> = 6弦3フレットと5弦5フレットの同時押さえ)</label>
							<input id="positions" type="text" class="mono" placeholder="例: 4:2 3:0 2:1" />
							<div class="status" id="status"></div>
						</div>

						<div class="spacer"></div>

						<div class="row" style="gap: 8px;">
							<button id="add" class="btn-accent">音符を追加</button>
							<button id="undo">1つ戻す</button>
							<button id="clear" class="btn-danger">すべてクリア</button>
						</div>
					</div>
				</div>

				<div id="stage">
					<div id="renderer" aria-label="譜面表示領域"></div>
				</div>

				<div class="help">
					ヒント: 弦番号は 1 が一番下(高音 E)、6 が一番上(低音 E) です。<br />
					まずは 4つの音を追加して 4/4 小節を作ってみましょう。VexFlow v4 を CDN 経由で読み込み、ブラウザだけで動作します。
				</div>
			</div>
		</main>

		<!-- VexFlow を ES Modules で読み込み -->
		<script type="module">
			import { Renderer, TabStave, TabNote, Voice, Formatter } from "https://cdn.jsdelivr.net/npm/vexflow@4.2.4/build/esm/vexflow.js";

			const state = {
				width: 920,
				height: 220,
				notes: [], // { positions: [{str, fret}], duration }
			};

			const $rendererHost = document.getElementById('renderer');
			const $positions = document.getElementById('positions');
			const $duration = document.getElementById('duration');
			const $status = document.getElementById('status');
			const $add = document.getElementById('add');
			const $undo = document.getElementById('undo');
			const $clear = document.getElementById('clear');

			function setStatus(msg, isError = false) {
				$status.style.color = isError ? 'var(--danger)' : 'var(--muted)';
				$status.textContent = msg || '';
			}

			function parsePositions(input) {
				// Accept formats like: "6:3 5:5" or "1:0" (space separated pairs)
				const tokens = input.trim().split(/\s+/).filter(Boolean);
				if (tokens.length === 0) return [];
				const positions = [];
				for (const t of tokens) {
					const m = t.match(/^(\d+)\s*[:：]\s*(\d+)$/);
					if (!m) throw new Error(`無効なトークン: ${t} (例: 6:3 5:5)`);
					const str = Number(m[1]);
					const fret = Number(m[2]);
					if (str < 1 || str > 6) throw new Error(`弦番号は 1〜6 の範囲で指定してください: ${str}`);
					if (fret < 0 || fret > 24) throw new Error(`フレット番号は 0〜24 を推奨します: ${fret}`);
					positions.push({ str, fret: String(fret) }); // VexFlow は fret を文字列で扱う
				}
				return positions;
			}

			function createRenderer() {
				// 既存の描画をクリア
				$rendererHost.innerHTML = '';
				const renderer = new Renderer($rendererHost, Renderer.Backends.SVG);
				renderer.resize(state.width, state.height);
				return renderer;
			}

			function render() {
				const renderer = createRenderer();
				const ctx = renderer.getContext();

				const stave = new TabStave(10, 30, state.width - 20);
				stave.addClef('tab');
				stave.setContext(ctx).draw();

				if (state.notes.length === 0) return; // 何も描かない

				// VexFlow の TabNote を生成
				const vfNotes = state.notes.map(n => new TabNote({ positions: n.positions, duration: n.duration }));

				// 音価合計はチェックしない(簡易)。Formatter に任せて横並び
			const voice = new Voice({ time: { num_beats: 4, beat_value: 4 } });
				voice.addTickables(vfNotes);

				new Formatter().joinVoices([voice]).format([voice], state.width - 80);
				voice.draw(ctx, stave);
			}

			function addNote() {
				try {
					const positions = parsePositions($positions.value);
					if (positions.length === 0) {
						setStatus('ポジションを入力してください (例: 6:3 5:5)');
						return;
					}
					const duration = $duration.value;
					state.notes.push({ positions, duration });
					setStatus('音符を追加しました');
					render();
					$positions.select();
				} catch (err) {
					console.error(err);
					setStatus(err.message || String(err), true);
				}
			}

			$add.addEventListener('click', addNote);
			$positions.addEventListener('keydown', (e) => {
				if (e.key === 'Enter') {
					e.preventDefault();
					addNote();
				}
			});
			$undo.addEventListener('click', () => {
				state.notes.pop();
				setStatus('最後の音符を削除しました');
				render();
			});
			$clear.addEventListener('click', () => {
				state.notes = [];
				setStatus('譜面をクリアしました');
				render();
			});

			// 初期デモ: 簡単な 4 分音符 4 つ
			state.notes = [
				{ positions: [{ str: 4, fret: '2' }], duration: 'q' },
				{ positions: [{ str: 3, fret: '2' }], duration: 'q' },
				{ positions: [{ str: 2, fret: '1' }], duration: 'q' },
				{ positions: [{ str: 1, fret: '0' }], duration: 'q' },
			];
			render();
		</script>
	</body>
	</html>
